<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BTM Profiler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    #signin-container { margin-bottom: 20px; }
    .hidden { display: none; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>User Profiles UI</h1>

  <div id="signin-container">
    <div id="g_id_signin"></div>
    <div class="error" id="auth-error"></div>
  </div>

  <div id="user-section" class="hidden">
    <p><strong>Signed in as:</strong> <span id="user-email"></span></p>
    <div id="profile-table">Loading...</div>
  </div>

  <script>
    const CLIENT_ID = '639261615144-evevtrl8oa7go9ttt1fa55l2sc95iudh.apps.googleusercontent.com';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwu74dRuTzF_x6X7QUMCDpHaIVS_OHslid-s7NPl7Nv0y3Ey9kmE30NTWpowB2HGcpyJw/exec';

    function handleCredentialResponse(response) {
      const idToken = response.credential;
      const jwtPayload = JSON.parse(atob(idToken.split('.')[1]));
      const userEmail = jwtPayload.email;

      document.getElementById("user-email").textContent = userEmail;

      fetch(`${APPS_SCRIPT_URL}?token=${encodeURIComponent(idToken)}`)
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          document.getElementById("auth-error").textContent = data.error;
        } else {
          showProfiles(data.profiles, data.email);
        }
      })
      .catch(err => {
        document.getElementById("auth-error").textContent = "Unexpected error: " + err.message;
      });
    }

    function showProfiles(data, email) {
      document.getElementById("signin-container").classList.add("hidden");
      document.getElementById("user-section").classList.remove("hidden");

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Name</th><th>Passport</th><th>ITN</th>
          <th>Phone</th><th>Email</th><th>Loyalty Card 1</th><th>Loyalty Card 2</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      data.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      const container = document.getElementById("profile-table");
      container.innerHTML = '';
      container.appendChild(table);
    }

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
        use_fedcm_for_prompt: false
      });

      google.accounts.id.renderButton(
        document.getElementById("g_id_signin"),
        { theme: "outline", size: "large" }
      );
    };
  </script>
</body>
</html>
